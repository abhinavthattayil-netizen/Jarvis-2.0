import React, { useState, useEffect, useRef, useCallback } from 'react';
import { Mic, MicOff, Send, Terminal, Activity, Cpu, Wifi, Battery, Volume2 } from 'lucide-react';

/**
 * JARVIS ASSISTANT
 * * A futuristic voice interface connected to Gemini.
 * Features:
 * - Web Speech API for STT (Speech-to-Text) and TTS (Text-to-Speech)
 * - Gemini 2.5 Flash for intelligence
 * - Sci-fi HUD animations
 */

const JarvisAssistant = () => {
  // --- State ---
  const [messages, setMessages] = useState([
    { role: 'system', content: 'J.A.R.V.I.S. Systems Online. Ready for input, sir.' }
  ]);
  const [inputText, setInputText] = useState('');
  const [isListening, setIsListening] = useState(false);
  const [isSpeaking, setIsSpeaking] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [currentTime, setCurrentTime] = useState(new Date());
  
  // --- Refs ---
  const chatEndRef = useRef(null);
  const recognitionRef = useRef(null);
  const synthRef = useRef(window.speechSynthesis);

  // --- Constants ---
  const apiKey = ""; // Injected by runtime environment

  // --- Effects ---

  // Clock
  useEffect(() => {
    const timer = setInterval(() => setCurrentTime(new Date()), 1000);
    return () => clearInterval(timer);
  }, []);

  // Auto-scroll to bottom of chat
  useEffect(() => {
    chatEndRef.current?.scrollIntoView({ behavior: 'smooth' });
  }, [messages]);

  // Initialize Speech Recognition
  useEffect(() => {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      recognitionRef.current = new SpeechRecognition();
      recognitionRef.current.continuous = false;
      recognitionRef.current.interimResults = false;
      recognitionRef.current.lang = 'en-US';

      recognitionRef.current.onstart = () => setIsListening(true);
      recognitionRef.current.onend = () => setIsListening(false);
      
      recognitionRef.current.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        setInputText(transcript);
        handleSend(transcript);
      };

      recognitionRef.current.onerror = (event) => {
        console.error("Speech recognition error", event.error);
        setIsListening(false);
      };
    } else {
      console.warn("Browser does not support Speech Recognition");
      setMessages(prev => [...prev, { role: 'system', content: 'Voice input not supported in this browser. Please use text.' }]);
    }
  }, []);

  // --- Functions ---

  const speak = (text) => {
    if (synthRef.current.speaking) {
      synthRef.current.cancel();
    }

    const utterance = new SpeechSynthesisUtterance(text);
    // Try to find a British male voice or a decent default
    const voices = synthRef.current.getVoices();
    const jarvisVoice = voices.find(v => v.name.includes('Google UK English Male')) || 
                        voices.find(v => v.name.includes('British')) || 
                        voices.find(v => v.lang === 'en-GB') ||
                        voices[0];
    
    if (jarvisVoice) utterance.voice = jarvisVoice;
    utterance.rate = 1;
    utterance.pitch = 1;

    utterance.onstart = () => setIsSpeaking(true);
    utterance.onend = () => setIsSpeaking(false);

    synthRef.current.speak(utterance);
  };

  const toggleListening = () => {
    if (isListening) {
      recognitionRef.current?.stop();
    } else {
      recognitionRef.current?.start();
    }
  };

  const callGemini = async (prompt) => {
    setIsProcessing(true);
    
    // System instruction to act like Jarvis
    const systemPrompt = `You are J.A.R.V.I.S. (Just A Rather Very Intelligent System). 
    You are speaking to your creator (address them as "Sir" or "Boss"). 
    Keep responses concise, witty, and extremely helpful. 
    You are a voice assistant, so avoid long code blocks or markdown unless explicitly asked.
    If asked about time/date, answer directly.
    Current context: The user is in a web interface simulation.`;

    try {
      const response = await fetch(
        `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: { parts: [{ text: systemPrompt }] }
          }),
        }
      );

      if (!response.ok) {
        throw new Error(`API Error: ${response.status}`);
      }

      const result = await response.json();
      const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "I am unable to process that request currently, Sir.";
      
      return text;
    } catch (error) {
      console.error("Gemini API Error:", error);
      return "My communication systems are currently offline, Sir. Please check the connection.";
    } finally {
      setIsProcessing(false);
    }
  };

  const handleSend = async (textOverride = null) => {
    const text = textOverride || inputText;
    if (!text.trim()) return;

    // User Message
    const userMsg = { role: 'user', content: text };
    setMessages(prev => [...prev, userMsg]);
    setInputText('');

    // Jarvis Response
    const responseText = await callGemini(text);
    const aiMsg = { role: 'assistant', content: responseText };
    
    setMessages(prev => [...prev, aiMsg]);
    speak(responseText);
  };

  const handleKeyDown = (e) => {
    if (e.key === 'Enter') handleSend();
  };

  // --- Render Helpers ---
  const formatTime = (date) => {
    return date.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
  };

  return (
    <div className="min-h-screen bg-black text-cyan-400 font-mono overflow-hidden relative selection:bg-cyan-900 selection:text-white">
      {/* Background Grid & Vignette */}
      <div className="absolute inset-0 bg-[linear-gradient(rgba(0,255,255,0.03)_1px,transparent_1px),linear-gradient(90deg,rgba(0,255,255,0.03)_1px,transparent_1px)] bg-[size:40px_40px]"></div>
      <div className="absolute inset-0 bg-radial-gradient from-transparent via-black/50 to-black pointer-events-none"></div>

      {/* Main Container */}
      <div className="relative z-10 container mx-auto h-screen flex flex-col p-4 md:p-8">
        
        {/* Header HUD */}
        <div className="flex justify-between items-start border-b border-cyan-900/50 pb-4 mb-4">
          <div className="flex items-center gap-4">
            <div className="relative w-12 h-12 flex items-center justify-center border-2 border-cyan-500 rounded-full animate-pulse-slow shadow-[0_0_15px_rgba(6,182,212,0.5)]">
               <Activity size={24} />
               <div className="absolute inset-0 rounded-full border border-cyan-300 animate-spin-slow opacity-50"></div>
            </div>
            <div>
              <h1 className="text-2xl font-bold tracking-widest text-cyan-100 drop-shadow-[0_0_10px_rgba(6,182,212,0.8)]">J.A.R.V.I.S.</h1>
              <p className="text-xs text-cyan-600 uppercase tracking-widest">Mark VII Interface</p>
            </div>
          </div>
          
          <div className="hidden md:flex gap-8 text-xs tracking-wider text-cyan-600">
             <div className="flex flex-col items-end">
                <span className="flex items-center gap-2"><Cpu size={14}/> CPU: NORMAL</span>
                <span className="text-cyan-400">34Â°C</span>
             </div>
             <div className="flex flex-col items-end">
                <span className="flex items-center gap-2"><Wifi size={14}/> NETWORK</span>
                <span className="text-cyan-400">SECURE</span>
             </div>
             <div className="flex flex-col items-end">
                <span className="flex items-center gap-2"><Battery size={14}/> POWER</span>
                <span className="text-cyan-400">100%</span>
             </div>
             <div className="text-4xl font-light text-cyan-100 drop-shadow-[0_0_5px_rgba(6,182,212,0.5)]">
               {formatTime(currentTime)}
             </div>
          </div>
        </div>

        {/* Center - Visualizer / Arc Reactor */}
        <div className="flex-1 flex flex-col items-center justify-center relative my-4">
          
          {/* Arc Reactor Animation */}
          <div 
            onClick={toggleListening}
            className={`relative w-48 h-48 md:w-64 md:h-64 rounded-full flex items-center justify-center cursor-pointer transition-all duration-500
              ${isListening ? 'scale-110 drop-shadow-[0_0_50px_rgba(6,182,212,0.8)]' : 'hover:scale-105 drop-shadow-[0_0_30px_rgba(6,182,212,0.4)]'}
            `}
          >
            {/* Outer Rings */}
            <div className={`absolute inset-0 rounded-full border-2 border-cyan-800 border-dashed animate-[spin_10s_linear_infinite] ${isProcessing ? 'border-cyan-400 duration-[2s]' : ''}`}></div>
            <div className="absolute inset-2 rounded-full border border-cyan-900 animate-[spin_15s_linear_infinite_reverse]"></div>
            <div className="absolute inset-4 rounded-full border-4 border-cyan-900/40"></div>
            
            {/* Core */}
            <div className={`absolute inset-8 rounded-full border-2 border-cyan-400/50 bg-cyan-950/30 backdrop-blur-sm flex items-center justify-center overflow-hidden
               ${isSpeaking ? 'animate-pulse' : ''}
            `}>
              {/* Inner details */}
              <div className="absolute w-full h-[1px] bg-cyan-500/50 top-1/2 -translate-y-1/2 rotate-45"></div>
              <div className="absolute w-full h-[1px] bg-cyan-500/50 top-1/2 -translate-y-1/2 -rotate-45"></div>
              
              {/* Icon / Status */}
              {isProcessing ? (
                <div className="w-16 h-16 border-t-4 border-cyan-200 rounded-full animate-spin"></div>
              ) : isListening ? (
                 <div className="flex gap-1 items-end h-16">
                    <div className="w-2 bg-cyan-400 animate-[bounce_1s_infinite] h-8"></div>
                    <div className="w-2 bg-cyan-400 animate-[bounce_1.2s_infinite] h-12"></div>
                    <div className="w-2 bg-cyan-400 animate-[bounce_0.8s_infinite] h-6"></div>
                    <div className="w-2 bg-cyan-400 animate-[bounce_1.1s_infinite] h-10"></div>
                 </div>
              ) : (
                <Mic className="text-cyan-400/80 w-16 h-16" />
              )}
            </div>
          </div>

          {/* Status Text */}
          <div className="mt-8 text-center h-12">
            <p className="text-cyan-300 text-lg tracking-[0.2em] font-light uppercase animate-pulse">
              {isListening ? "Listening..." : isProcessing ? "Processing..." : isSpeaking ? "Speaking..." : "Standby Mode"}
            </p>
          </div>

          {/* Messages Area (Simulated Terminal) */}
          <div className="w-full max-w-2xl h-48 md:h-64 overflow-y-auto mt-4 p-4 border border-cyan-900/50 bg-black/40 backdrop-blur-sm rounded-lg shadow-inner scrollbar-thin scrollbar-thumb-cyan-900 scrollbar-track-transparent">
             {messages.map((msg, idx) => (
               <div key={idx} className={`mb-3 flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                 <div className={`max-w-[80%] p-2 rounded ${msg.role === 'user' ? 'bg-cyan-900/20 text-cyan-100 border-l-2 border-cyan-500' : 'text-cyan-300'}`}>
                    <span className="text-[10px] uppercase opacity-50 block mb-1">
                      {msg.role === 'user' ? 'CMD: USER' : 'SYS: J.A.R.V.I.S.'}
                    </span>
                    {msg.content}
                 </div>
               </div>
             ))}
             <div ref={chatEndRef} />
          </div>

        </div>

        {/* Footer Input */}
        <div className="relative mt-auto pt-4">
          <div className="flex items-center gap-2 bg-cyan-950/20 border border-cyan-800 p-2 rounded-full hover:border-cyan-500 transition-colors shadow-[0_0_15px_rgba(0,0,0,0.5)]">
            <button 
              onClick={toggleListening}
              className={`p-3 rounded-full transition-all ${isListening ? 'bg-red-500/20 text-red-400 shadow-[0_0_10px_rgba(248,113,113,0.5)]' : 'bg-cyan-900/20 text-cyan-400 hover:bg-cyan-800/40'}`}
            >
              {isListening ? <MicOff size={20} /> : <Mic size={20} />}
            </button>
            
            <input 
              type="text" 
              value={inputText}
              onChange={(e) => setInputText(e.target.value)}
              onKeyDown={handleKeyDown}
              placeholder="Enter command..."
              className="flex-1 bg-transparent border-none outline-none text-cyan-100 placeholder-cyan-800 font-mono tracking-wider"
              disabled={isListening || isProcessing}
            />
            
            <button 
              onClick={() => handleSend()}
              disabled={!inputText.trim() || isProcessing}
              className="p-3 text-cyan-400 hover:text-cyan-100 disabled:opacity-30 disabled:hover:text-cyan-400"
            >
              {isProcessing ? <div className="w-5 h-5 border-2 border-t-transparent border-cyan-400 rounded-full animate-spin"></div> : <Send size={20} />}
            </button>
          </div>
          
          <div className="flex justify-between mt-2 px-2 text-[10px] text-cyan-800 uppercase tracking-widest">
            <span>System Status: Online</span>
            <span>Protocols: Active</span>
          </div>
        </div>

      </div>
      
      {/* CSS Animations for React */}
      <style>{`
        @keyframes spin-slow {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
        .animate-spin-slow {
          animation: spin-slow 8s linear infinite;
        }
        .animate-pulse-slow {
           animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .scrollbar-hidden::-webkit-scrollbar {
            display: none;
        }
        /* Hide scrollbar for IE, Edge and Firefox */
        .scrollbar-hidden {
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
      `}</style>
    </div>
  );
};

export default JarvisAssistant;

